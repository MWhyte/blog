<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0" xmlns:media="http://search.yahoo.com/mrss/"><channel><title><![CDATA[codenerve]]></title><description><![CDATA[Software Development Tutorials]]></description><link>https://codenerve.com/</link><image><url>https://codenerve.com/favicon.png</url><title>codenerve</title><link>https://codenerve.com/</link></image><generator>Ghost 3.34</generator><lastBuildDate>Tue, 22 Sep 2020 22:46:48 GMT</lastBuildDate><atom:link href="https://codenerve.com/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[Tracing REST Services with Zipkin]]></title><description><![CDATA[<p>Whether you deploy to the cloud or on-prem, one of the biggest challenges of a microservice or distributed architecture is monitoring.</p><p><a href="https://github.com/openzipkin/zipkin">Zipkin</a> is a distributed tracing system that can help to solve some of these problems. Specifically, it helps gather data needed to troubleshoot latency issues.</p><p>In this article, we</p>]]></description><link>https://codenerve.com/spring-cloud-zipkin/</link><guid isPermaLink="false">5f1203ad07a62a995513aee0</guid><category><![CDATA[spring-cloud]]></category><category><![CDATA[kotlin]]></category><category><![CDATA[spring]]></category><dc:creator><![CDATA[Michael Whyte]]></dc:creator><pubDate>Fri, 17 Jul 2020 20:01:49 GMT</pubDate><media:content url="https://images.unsplash.com/photo-1475115996703-5200b5adbc09?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=2000&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjExNzczfQ" medium="image"/><content:encoded><![CDATA[<img src="https://images.unsplash.com/photo-1475115996703-5200b5adbc09?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Tracing REST Services with Zipkin"><p>Whether you deploy to the cloud or on-prem, one of the biggest challenges of a microservice or distributed architecture is monitoring.</p><p><a href="https://github.com/openzipkin/zipkin">Zipkin</a> is a distributed tracing system that can help to solve some of these problems. Specifically, it helps gather data needed to troubleshoot latency issues.</p><p>In this article, we look at <strong>spring clouds support for Zipkin</strong> by setting up some spring boot REST services.</p><p>The example code is written in kotlin but can easily be ported over to java.</p><p></p><blockquote><strong>Source code for this example can be found on github:</strong></blockquote><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/codenerve-com/tutorials/tree/master/kotlin/spring-cloud-zipkin"><div class="kg-bookmark-content"><div class="kg-bookmark-title">codenerve-com/tutorials</div><div class="kg-bookmark-description">Example code for blog posts written over @ codenerve.com - codenerve-com/tutorials</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://github.githubassets.com/favicons/favicon.svg" alt="Tracing REST Services with Zipkin"><span class="kg-bookmark-author">codenerve-com</span><span class="kg-bookmark-publisher">GitHub</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://avatars3.githubusercontent.com/u/58404900?s=400&amp;v=4" alt="Tracing REST Services with Zipkin"></div></a></figure><hr><h3 id="prerequisites">Prerequisites</h3><p>You'll need some things to follow along with the example:</p><ul><li>Java</li><li>Maven</li><li>Docker (including <a href="https://docs.docker.com/compose/install/">docker-compose</a>)</li><li>The source code cloned and imported into your IDE</li></ul><h3 id="setting-the-scene">Setting the scene</h3><p>To demonstrate Zipkin's tracing abilities, we are going to bring up some fictitious services that our service can make requests to.</p><p><br>Our service will return the tax of an employee based on their name:</p><pre><code class="language-bash">$ curl http://localhost:8080/tax\?name\=michael
$ 10000.0</code></pre><p>To do this, it needs some help for other services:</p><ul><li>An employee service which will return employee information by name</li><li>A payroll service which will return the employees tax code by employee id.</li></ul><p>Finally, our service will calculate and return the tax to be paid.</p><p>Additionally, we will bring up a Zipkin server which our service will push trace data to.</p><figure class="kg-card kg-image-card"><img src="https://codenerve.com/content/images/2020/07/diagram.jpg" class="kg-image" alt="Tracing REST Services with Zipkin" srcset="https://codenerve.com/content/images/size/w600/2020/07/diagram.jpg 600w, https://codenerve.com/content/images/size/w1000/2020/07/diagram.jpg 1000w, https://codenerve.com/content/images/size/w1600/2020/07/diagram.jpg 1600w, https://codenerve.com/content/images/size/w2400/2020/07/diagram.jpg 2400w" sizes="(min-width: 720px) 720px"></figure><hr><p>The employee and payroll service will be mocked out using <a href="https://www.mock-server.com/">mockserver</a>. We will not be covering mockserver in this post. </p><p>There are two json files under the dist directory that tell the mock services how to respond to requests, including some delays which will slow down there response times.</p><hr><h3 id="compose">Compose</h3><p>To manage all this, we will be using a docker compose yml file:</p><figure class="kg-card kg-code-card"><pre><code class="language-java">version: '2.0'
services:
  zipkin:
    container_name: zipkin
    image: openzipkin/zipkin
    ports:
      - 8081:9411

  employee-service:
    container_name: employee-service
    image: mockserver/mockserver
    ports:
      - 8082:1080
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/initializerJson.json
    volumes:
    - ./dist/employee-service:/config

  payroll-service:
    container_name: payroll-service
    image: mockserver/mockserver
    ports:
      - 8083:1080
    environment:
      MOCKSERVER_INITIALIZATION_JSON_PATH: /config/initializerJson.json
    volumes:
      - ./dist/payroll-service:/config
</code></pre><figcaption><a href="https://github.com/codenerve-com/tutorials/blob/master/kotlin/spring-cloud-zipkin/docker-compose.yml">docker-compose.yml</a></figcaption></figure><p></p><p>Let's start everything up now by running:</p><pre><code class="language-bash">docker-compose -f docker-compose.yml up</code></pre><p><em>N.B you can optionally background the process by adding -d to the end of this command</em></p><h3 id="creating-a-basic-rest-service">Creating a Basic Rest Service</h3><p>Creating the service is very simple, and if you're happy with spring boots defaults then this only involves adding a jar to your maven pom!</p><figure class="kg-card kg-code-card"><pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
    &lt;version&gt;2.2.0.RC1&lt;/version&gt;
&lt;/dependency&gt;</code></pre><figcaption><a href="https://github.com/codenerve-com/tutorials/blob/master/kotlin/spring-cloud-zipkin/pom.xml">pom.xml</a></figcaption></figure><p>Default properties such as zipkin urls can be overidden under <em>src/main/resources/application.properties</em> </p><p>A full list of properties are listed in the spring cloud <a href="https://cloud.spring.io/spring-cloud-sleuth/reference/html/appendix.html">documentation</a></p><h3 id="hitting-the-endpoint">Hitting the endpoint</h3><p>Start the service in your IDE and navigate to it in your browser:</p><!--kg-card-begin: html--><table style="width:100%">
  <tr>
    <td>Service</td>
    <td><a href="http://localhost:8080/tax?name=michael">http://localhost:8080/tax?name=michael"</a></td>
  </tr>
  <tr>
    <td>Zipkin UI</td>
    <td><a href="http://localhost:8081">http://localhost:8081</a></td>
  </tr>
  <tr>
    <td>Mock Employee Service</td>
    <td><a href="http://localhost:8082/employeeService">http://localhost:8082/employeeService</a></td>
  </tr>
  <tr>
    <td>Mock Payroll Service</td>
    <td><a href="http://localhost:8083/payrollService">http://localhost:8083/payrollService</a></td>
  </tr>
</table><!--kg-card-end: html--><p></p><p>Now navigate to the Zipkin UI. Click on <em>Find Traces</em> and you will see the trace you created by opening the service url. </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://codenerve.com/content/images/2020/07/zipkin-ui-1-1.png" class="kg-image" alt="Tracing REST Services with Zipkin" srcset="https://codenerve.com/content/images/size/w600/2020/07/zipkin-ui-1-1.png 600w, https://codenerve.com/content/images/size/w1000/2020/07/zipkin-ui-1-1.png 1000w, https://codenerve.com/content/images/size/w1600/2020/07/zipkin-ui-1-1.png 1600w, https://codenerve.com/content/images/2020/07/zipkin-ui-1-1.png 1656w" sizes="(min-width: 720px) 720px"><figcaption>zipkin ui</figcaption></figure><hr><p>Click on a span to expand it:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://codenerve.com/content/images/2020/07/zipkin-ui-2-1.png" class="kg-image" alt="Tracing REST Services with Zipkin" srcset="https://codenerve.com/content/images/size/w600/2020/07/zipkin-ui-2-1.png 600w, https://codenerve.com/content/images/size/w1000/2020/07/zipkin-ui-2-1.png 1000w, https://codenerve.com/content/images/size/w1600/2020/07/zipkin-ui-2-1.png 1600w, https://codenerve.com/content/images/size/w2400/2020/07/zipkin-ui-2-1.png 2400w" sizes="(min-width: 720px) 720px"><figcaption>zipkin ui</figcaption></figure><h3 id="apache-benchmark">Apache Benchmark</h3><p>Additionally you could use a tool like <a href="https://httpd.apache.org/docs/2.4/programs/ab.html">apache benchmark</a> to put the service under some load. This will create more traces that can be viewed in the zipkin ui:</p><pre><code class="language-html">ab -n 500 -c 20 "http://localhost:8080/tax?name=michael"</code></pre><p></p><h3 id="conclusion">Conclusion </h3><p>We've seen just how easy it is to add tracing to your spring cloud application. </p><p>For more info, see the <a href="https://docs.spring.io/spring-cloud-sleuth/docs/current-SNAPSHOT/reference/html/">spring cloud docs</a> or the <a href="https://github.com/openzipkin/sleuth-webmvc-example">openzipkin examples</a> on github. </p><p></p>]]></content:encoded></item><item><title><![CDATA[Spring Security - Redirect based on User Roles]]></title><description><![CDATA[<p>So far we’ve built a basic spring boot application, enabled spring security and built a <a href="https://www.codenerve.com/spring-security-basic-login-form/">basic login form</a>. In the last lesson, we expanded on the first lesson by adding different user roles and the ability to show and hide front-end content based on these roles <a href="https://www.codenerve.com/spring-security-thymeleaf-extras/" rel="noopener noreferrer">(User Roles and</a></p>]]></description><link>https://codenerve.com/spring-security-user-role-redirect/</link><guid isPermaLink="false">5f1203ad07a62a995513aedd</guid><category><![CDATA[spring]]></category><category><![CDATA[java]]></category><dc:creator><![CDATA[Michael Whyte]]></dc:creator><pubDate>Fri, 03 May 2019 21:23:35 GMT</pubDate><media:content url="https://images.unsplash.com/photo-1542850131-f8059d51b857?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=2000&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjExNzczfQ" medium="image"/><content:encoded><![CDATA[<img src="https://images.unsplash.com/photo-1542850131-f8059d51b857?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Spring Security - Redirect based on User Roles"><p>So far we’ve built a basic spring boot application, enabled spring security and built a <a href="https://www.codenerve.com/spring-security-basic-login-form/">basic login form</a>. In the last lesson, we expanded on the first lesson by adding different user roles and the ability to show and hide front-end content based on these roles <a href="https://www.codenerve.com/spring-security-thymeleaf-extras/" rel="noopener noreferrer">(User Roles and Thymeleaf Extras).</a></p><p></p><p>Today, we’ll be looking at redirecting users with different roles to different pages after they log in.</p><blockquote><strong>Source code for this example can be found on github:</strong></blockquote><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/codenerve-com/spring-security/tree/3.redirect-based-on-role"><div class="kg-bookmark-content"><div class="kg-bookmark-title">codenerve-com/spring-security</div><div class="kg-bookmark-description">An introduction to spring security. Contribute to codenerve-com/spring-security development by creating an account on GitHub.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://github.githubassets.com/favicons/favicon.svg" alt="Spring Security - Redirect based on User Roles"><span class="kg-bookmark-author">codenerve-com</span><span class="kg-bookmark-publisher">GitHub</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://avatars3.githubusercontent.com/u/58404900?s=400&amp;v=4" alt="Spring Security - Redirect based on User Roles"></div></a></figure><hr><p>Some files are already set up for you from the previous lesson: <a href="https://www.codenerve.com/spring-security-thymeleaf-extras/" rel="noopener noreferrer">Spring Security – User Roles and Thymeleaf Extras</a>. Please start here or check out the complete code from the link above.</p><h3 id="admin-html">Admin.html</h3><p>Following on from our previous example, we have now created a new HTML file called Admin.html. This is the page we will redirect admins to when they log in.</p><figure class="kg-card kg-code-card"><pre><code class="language-html">&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"&gt;

&lt;head&gt;
    &lt;title&gt;codenerve.com - Welcome!&lt;/title&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Admin&lt;/title&gt;
    &lt;link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"&gt;
    &lt;link rel="stylesheet" href="css/style.css"&gt;
&lt;/head&gt;
    &lt;body&gt;
        &lt;h1 th:inline="text"&gt;Hello [[${#httpServletRequest.remoteUser}]]!&lt;/h1&gt;

        &lt;div&gt;
             Custom administrator page.
        &lt;/div&gt;

        &lt;br/&gt;
        &lt;form th:action="@{/logout}" method="post"&gt;
            &lt;input type="submit" value="Sign Out"/&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre><figcaption><a href="https://github.com/codenerve-com/spring-security/blob/3.redirect-based-on-role/src/main/resources/templates/admin.html">admin.html</a></figcaption></figure><p></p><h3 id="mvcconfig">MvcConfig</h3><p>Now, to serve the new <em>admin.html</em> page, we must add this page to our <em>MvcConfig</em>.</p><p>As with the previous examples, this is done by creating a class, extending <em>WebMvcConfigurerAdapter</em> and overriding the <em>addViewControllers</em> method. This time adding all the earlier pages of our app and the new admin page:</p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Configuration
public class MvcConfig extends WebMvcConfigurerAdapter {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/").setViewName("login");
        registry.addViewController("/index").setViewName("index");
        registry.addViewController("/admin").setViewName("admin");
        registry.addViewController("/login").setViewName("login");
    }
}</code></pre><figcaption><a href="https://github.com/codenerve-com/spring-security/blob/3.redirect-based-on-role/src/main/java/com/codenerve/spring/sec/config/MvcConfig.java">MvcConfig.java</a></figcaption></figure><p></p><h3 id="websecurityconfig">WebSecurityConfig</h3><p><strong>The Constructor</strong></p><p>In order to decide what to do when different user roles login. We have created a new field of type <em>AuthenticationSuccessHandler</em>. We’re setting this new configuration bean via constructor injection.</p><p><strong>configure method</strong></p><p>This method is in charge of overriding and configuring <em>HttpSecurity</em> explicitly. From the last example, we have added two lines.</p><p>First, we’ve added a new antMatcher under the <em>authorizeRequests</em> section, and we’ve told spring security only to allow a user with the ‘ADMIN’ role access to all endpoints starting with ‘/admin’:</p><pre><code class="language-java">.antMatchers("/admin").hasRole("ADMIN")</code></pre><p>Secondly, we’ve added our <em>CustomAuthenticationSuccessHandler</em> under the formLogin section to tell spring security to ask this <em>CustomAuthenticationSuccessHandler</em> what to do when a successful login occurs:</p><pre><code class="language-java">.successHandler(authenticationSuccessHandler)</code></pre><p><strong>configureGlobal method</strong></p><p>The <em>configureGlobal</em> method is our in-memory registry of users. We’ve added two users. One with the primary ‘USER’ role and the other with the ‘ADMIN’ role.</p><p><strong>Full example:</strong></p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    private AuthenticationSuccessHandler authenticationSuccessHandler;

    @Autowired
    public WebSecurityConfig(AuthenticationSuccessHandler authenticationSuccessHandler) {
        this.authenticationSuccessHandler = authenticationSuccessHandler;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers( "/css/**").permitAll()
                .antMatchers("/admin").hasRole("ADMIN")
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .loginPage("/login")
                .successHandler(authenticationSuccessHandler)
                .permitAll()
                .and()
                .logout()
                .permitAll()
                .and().csrf().disable(); // we'll enable this in a later blog post
    }

    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth
                .inMemoryAuthentication()
                .withUser("user").password("pass").roles("USER")
                .and()
                .withUser("admin").password("pass").roles("ADMIN");
    }
}</code></pre><figcaption><a href="https://github.com/codenerve-com/spring-security/blob/3.redirect-based-on-role/src/main/java/com/codenerve/spring/sec/config/WebSecurityConfig.java">WebSecurityConfig.java</a></figcaption></figure><p></p><h3 id="customauthenticationsuccesshandler">CustomAuthenticationSuccessHandler</h3><p>As you can see from our sample code below this class implements springs <em>AuthenticationSuccessHandler</em> class and overrides the <em>onAuthenticationSuccess</em> method.</p><p>Once a user is successfully logged in, this method is called and within this method, the user’s role is checked. If the user’s role is admin we redirect to the ‘/admin’ HTTP endpoint otherwise we redirect them to the ‘/index’ endpoint.</p><p>At this point, our <em>MvcConfig</em> takes over and serves the correct HTML page based on the viewController we created previously.</p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Configuration
public class CustomAuthenticationSuccessHandler implements AuthenticationSuccessHandler {


    @Override
    public void onAuthenticationSuccess(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) throws IOException, ServletException {

        Set&lt;String&gt; roles = AuthorityUtils.authorityListToSet(authentication.getAuthorities());

        if (roles.contains("ROLE_ADMIN")) {
            httpServletResponse.sendRedirect("/admin");
        } else {
            httpServletResponse.sendRedirect("/index");
        }
    }
}</code></pre><figcaption><a href="https://github.com/codenerve-com/spring-security/blob/3.redirect-based-on-role/src/main/java/com/codenerve/spring/sec/config/CustomAuthenticationSuccessHandler.java">CustomAuthenticationSuccessHandler.java</a></figcaption></figure><p></p><h3 id="demo">Demo</h3><p>To run the demo, open the <em>Application</em> class and right-click run. To start the example, port 8080 will need to be available on your machine. If it is not, you can change this default in the application.properties file using:</p><pre><code class="language-bash">server.port=8081</code></pre><p>Set this to whatever value you wish.</p><figure class="kg-card kg-embed-card"><iframe width="459" height="344" src="https://www.youtube.com/embed/jTku174kytg?feature=oembed" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></figure><p></p><h3 id="testing">Testing</h3><p>As always we have amended an added some additonal tests to conver a new functionality</p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Test
@WithMockUser(roles = "USER")
public void loginWithRoleUserThenExpectAdminPageForbidden() throws Exception {
	mockMvc.perform(get("/admin"))
			.andExpect(status().isForbidden());
}

@Test
@WithMockUser(roles = "ADMIN")
public void loginWithRoleAdminThenExpectAdminContent() throws Exception {
	mockMvc.perform(get("/admin"))
			.andExpect(status().isOk())
			.andExpect(content().string(containsString("Custom administrator page.")));
}

@Test
public void loginWithRoleUserThenExpectIndexPageRedirect() throws Exception {
	FormLoginRequestBuilder login = formLogin()
			.user("user")
			.password("pass");

	mockMvc.perform(login)
			.andExpect(authenticated().withUsername("user"))
			.andExpect(redirectedUrl("/index"));
}

@Test
public void loginWithRoleAdminThenExpectAdminPageRedirect() throws Exception {
	FormLoginRequestBuilder login = formLogin()
			.user("admin")
			.password("pass");

	mockMvc.perform(login)
			.andExpect(authenticated().withUsername("admin"))
			.andExpect(redirectedUrl("/admin"));
}</code></pre><figcaption><a href="https://github.com/codenerve-com/spring-security/blob/3.redirect-based-on-role/src/test/java/com/codenerve/spring/sec/ApplicationTests.java">ApplicationTests.java</a></figcaption></figure><p></p><h3 id="next">Next</h3><p>Next up, we will be covering spring security’s Cross Site Request Forgery (CSRF) protection.</p>]]></content:encoded></item><item><title><![CDATA[Spring Security - User Roles and ThymeLeaf Extras]]></title><description><![CDATA[<p>In the last lesson, we learnt how to use spring security to build a <a href="https://www.codenerve.com/spring-security-basic-login-form/">basic login form</a>. </p><p>Today, we'll be looking at adding user roles and some nice feature's of the Thymeleaf library to show and hide content based on these roles.</p><blockquote><strong>Source code for this example can be found</strong></blockquote>]]></description><link>https://codenerve.com/spring-security-thymeleaf-extras/</link><guid isPermaLink="false">5f1203ad07a62a995513aedc</guid><category><![CDATA[spring]]></category><category><![CDATA[java]]></category><dc:creator><![CDATA[Michael Whyte]]></dc:creator><pubDate>Tue, 30 Apr 2019 22:18:14 GMT</pubDate><media:content url="https://images.unsplash.com/photo-1517650862521-d580d5348145?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=2000&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjExNzczfQ" medium="image"/><content:encoded><![CDATA[<img src="https://images.unsplash.com/photo-1517650862521-d580d5348145?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Spring Security - User Roles and ThymeLeaf Extras"><p>In the last lesson, we learnt how to use spring security to build a <a href="https://www.codenerve.com/spring-security-basic-login-form/">basic login form</a>. </p><p>Today, we'll be looking at adding user roles and some nice feature's of the Thymeleaf library to show and hide content based on these roles.</p><blockquote><strong>Source code for this example can be found on github:</strong></blockquote><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/codenerve-com/spring-security/tree/2.thymeleaf-extras"><div class="kg-bookmark-content"><div class="kg-bookmark-title">codenerve-com/spring-security</div><div class="kg-bookmark-description">An introduction to spring security. Contribute to codenerve-com/spring-security development by creating an account on GitHub.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://github.githubassets.com/favicons/favicon.svg" alt="Spring Security - User Roles and ThymeLeaf Extras"><span class="kg-bookmark-author">codenerve-com</span><span class="kg-bookmark-publisher">GitHub</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://avatars3.githubusercontent.com/u/58404900?s=400&amp;v=4" alt="Spring Security - User Roles and ThymeLeaf Extras"></div></a></figure><hr><h3 id="dependencies">Dependencies</h3><p>As with all Spring boot application's, there are a number of starter libraries that make it easy to add jars to your classpath. In addition, these can auto-configure various spring beans and behaviours that we can make use of. Building upon the previous lesson we will be adding:</p><ul><li>thymeleaf-extras-springsecurity4 - this has a number of additional features over the basic thymeleaf jar</li></ul><p></p><h3 id="websecurityconfig">WebSecurityConfig</h3><p>To begin this lesson we'll be adding another user to our application's WebSecurityConfig but this time giving them a new role 'admin':</p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    auth
        .inMemoryAuthentication()
        .withUser("user").password("{noop}pass").roles("USER")
        .and()
        .withUser("admin").password("{noop}pass").roles("ADMIN");
}</code></pre><figcaption>WebSecurityConfig.java</figcaption></figure><p>This now gives us two available user's to log in with. </p><p>Each is configured with a different role that we can now use to hide and show various content.</p><h3 id="thymeleaf-authorize">Thymeleaf: Authorize</h3><p>Next, we'll be using a Thymeleaf attribute <em>sec:authorize</em> to check a users roles before rendering the div's in our index.html page.</p><p>To do this, go to the index.html page and add the following HTML inside the body tags:</p><figure class="kg-card kg-code-card"><pre><code class="language-html">&lt;div sec:authorize="hasRole('ADMIN')"&gt;
    This content is only shown to administrators.
&lt;/div&gt;

&lt;div sec:authorize="hasRole('USER')"&gt;
    This content is only shown to users.
&lt;/div&gt;</code></pre><figcaption>index.html</figcaption></figure><p>As you can see the <em>sec:authorize</em> attribute is added to each div, and we use something called the spring security dialect to check users spring security roles. Content will only be rendered if the logged-in user has that role. i.e. <em>hasRole</em> returns true.</p><p>It is important to note that content is not just hidden from view but will not be rendered at all when our application server returns the page to the browser.</p><h3 id="thymeleaf-authentication">Thymeleaf: Authentication</h3><p>Another useful Thymeleaf feature is the <em>sec:authentication</em> attribute. This can return various security-related metadata. In the example below, we can retrieve the user's username and roles and display these in our HTML.</p><figure class="kg-card kg-code-card"><pre><code class="language-html">&lt;div&gt;
    User: &lt;span sec:authentication="name"&gt;NOT FOUND&lt;/span&gt;
    Spring Roles: &lt;span sec:authentication="principal.authorities"&gt;NOT FOUND&lt;/span&gt;
&lt;/div&gt;</code></pre><figcaption>index.html</figcaption></figure><p>For more useful attribute's see <a href="https://github.com/thymeleaf/thymeleaf-extras-springsecurity">the Thymeleaf documentation</a></p><h3 id="demo">Demo</h3><p>To run the demo, open the Application class and right click run. In order to start the example, the port 8080 will need to be available on your machine. If it is not you can change this default in the application.properties file using:</p><pre><code class="language-bash">server.port=8081</code></pre><p>Set this to whatever value you wish.</p><figure class="kg-card kg-embed-card"><iframe width="612" height="344" src="https://www.youtube.com/embed/khAjDT9szTM?feature=oembed" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></figure><h3 id="unit-testing">Unit Testing</h3><p>We've added a few more unit tests to cover this new functionality:</p><figure class="kg-card kg-code-card"><pre><code class="language-java">@Test
@WithMockUser(roles = "USER")
public void loginWithRoleUserThenExpectUserSpecificContent() throws Exception {
	mockMvc.perform(get("/index"))
			.andExpect(status().isOk())
			.andExpect(content().string(containsString("This content is only shown to users.")))
			.andExpect(content().string(doesNotContainString("This content is only shown to administrators.")));
}

@Test
@WithMockUser(roles = "ADMIN")
public void loginWithRoleAdminThenExpectAdminSpecificContent() throws Exception {
	mockMvc.perform(get("/index"))
			.andExpect(status().isOk())
			.andExpect(content().string(containsString("This content is only shown to administrators.")))
			.andExpect(content().string(doesNotContainString("This content is only shown to users.")));
}

private Matcher&lt;String&gt; doesNotContainString(String s) {
	return CoreMatchers.not(containsString(s));
}</code></pre><figcaption>ApplicationTests.java</figcaption></figure><p>As you can see we've created a utility method <em>doesNotContainString</em>. Using this and Hamcrests <em>containsString</em> method, we can check that content is rendered (or not) based on a particular user role.</p><h3 id="next"><a href="https://codenerve.com/spring-security-user-role-redirect/">Next</a></h3><p>Next up, we will be continuing to cover spring security's user roles, but this time we will be redirecting admins to there own admin page (admin.html) and securing this page so that only admin users can access it.</p><p></p>]]></content:encoded></item><item><title><![CDATA[Spring Security - Basic Login Form]]></title><description><![CDATA[<p>In this series, I hope to show you some techniques for using spring security and the broader spring ecosystem to build and develop secure application web servers.</p><p>Today, we’ll be looking at building a basic login form page using:</p><ul><li>Spring Boot</li><li>Spring Security, and</li><li>Thymeleaf</li></ul><blockquote>Source code for this</blockquote>]]></description><link>https://codenerve.com/spring-security-basic-login-form/</link><guid isPermaLink="false">5f1203ad07a62a995513aedb</guid><category><![CDATA[spring]]></category><category><![CDATA[java]]></category><dc:creator><![CDATA[Michael Whyte]]></dc:creator><pubDate>Thu, 25 Apr 2019 22:20:29 GMT</pubDate><media:content url="https://images.unsplash.com/photo-1489875347897-49f64b51c1f8?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=2000&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjExNzczfQ" medium="image"/><content:encoded><![CDATA[<img src="https://images.unsplash.com/photo-1489875347897-49f64b51c1f8?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Spring Security - Basic Login Form"><p>In this series, I hope to show you some techniques for using spring security and the broader spring ecosystem to build and develop secure application web servers.</p><p>Today, we’ll be looking at building a basic login form page using:</p><ul><li>Spring Boot</li><li>Spring Security, and</li><li>Thymeleaf</li></ul><blockquote>Source code for this example can be found on github:</blockquote><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/codenerve-com/spring-security"><div class="kg-bookmark-content"><div class="kg-bookmark-title">codenerve-com/spring-security</div><div class="kg-bookmark-description">An introduction to spring security. Contribute to codenerve-com/spring-security development by creating an account on GitHub.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://github.githubassets.com/favicons/favicon.svg" alt="Spring Security - Basic Login Form"><span class="kg-bookmark-author">codenerve-com</span><span class="kg-bookmark-publisher">GitHub</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://avatars3.githubusercontent.com/u/58404900?s=400&amp;v=4" alt="Spring Security - Basic Login Form"></div></a></figure><hr><p>First off lets briefly cover some of the project files that are of less interest:</p><ul><li><em><em>Application.java</em></em> — contains our main method and the <em><em>@SpringBootApplication </em></em>annotation.</li><li>A CSS stylesheet is located under src/main/resources/static/css/ to make the demo pretty</li><li>Some Thymeleaf HTML templates are located under src/main/resources/ for demo purposes also</li><li>An <em><em>application.properties</em></em> file is located under src/main/resources where we can pass configuration parameters to our spring boot application. A full list of options can be found <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html">here</a></li></ul><hr><h3 id="dependencies">Dependencies</h3><p>As with all Spring boot application’s, there are a number of ‘Starter’ libraries that make it easy to add jars to your classpath.<br>In addition, these can auto-configure various spring beans and behaviours that we can make use of:</p><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;com.codenerve&lt;/groupId&gt;
	&lt;artifactId&gt;spring-security-basic&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;

	&lt;name&gt;spring-security-basic&lt;/name&gt;
	&lt;description&gt;An introduction to spring security&lt;/description&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.1.5.RELEASE&lt;/version&gt;
	&lt;/parent&gt;

	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
		&lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
		&lt;/dependency&gt;


		&lt;!-- TEST --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
			&lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;
&lt;/project&gt;</code></pre><ul><li>spring-boot-starter-parent — brings in all the required spring dependencies and manages there versions</li><li>spring-boot-starter-thymeleaf — adds thymeleaf-spring5 and thymeleaf-extras-java8time dependencies (<a href="http://www.thymeleaf.org/" rel="noopener nofollow">more on thymeleaf</a>)</li><li>spring-boot-starter-security — adds spring-security-config, spring-security-web and spring-aop dependencies</li><li>spring-boot-starter-test — adds spring-boot-test, junit, <a href="http://hamcrest.org/" rel="noopener nofollow">hamcrest</a> and <a href="https://site.mockito.org/" rel="noopener nofollow">mockito</a></li><li>spring-security-test — adds the ability to mock user and user roles</li></ul><h3 id="mvcconfig">MvcConfig</h3><pre><code class="language-java">@Configuration
public class MvcConfig implements WebMvcConfigurer {

    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/").setViewName("login");
        registry.addViewController("/index").setViewName("index");
        registry.addViewController("/login").setViewName("login");
    }
}</code></pre><p>This class implements spring’s <em><em>WebMvcConfigurer </em></em>interface. This allows you to override the method <em><em>addViewControllers</em></em> (as well as others) which is a way to configure simple automated controllers. In this example, we have mapped them to our Thymeleaf views (under src/main/resources).</p><h3 id="websecurityconfig">WebSecurityConfig</h3><pre><code class="language-java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers( "/css/**").permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .loginPage("/login")
                .defaultSuccessUrl("/index")
                .permitAll()
                .and()
                .logout()
                .permitAll()
                .and().csrf().disable(); // we'll enable this in a later blog post
    }

    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth
                .inMemoryAuthentication()
                .withUser("user").password("{noop}pass").roles("USER");
    }
}</code></pre><p>There’s a lot going on in this class as it contains the main security configuration to enable and configure our basic login form.</p><p><strong><strong>@EnableWebSecurity</strong></strong><br>A Marker which allows spring to find your custom web application security configuration</p><p><strong><strong>WebSecurityConfigurerAdapter</strong></strong><br>Another abstract base class that allows you to override certain aspects of spring security’s default configuration. In our case, we are going to override the methods <em><em>configure</em></em> and <em><em>configureGlobal</em></em>.</p><p><strong><strong>configure(HttpSecurity http) method</strong></strong><br>Note the parameter passed to this method. There are several different configure methods. We will be overriding and configuring <em><em>HttpSecurity </em></em>specifically<em><em>.</em></em></p><ul><li><em><em>authorizeRequests()</em></em> — Allows us to configure which resources on our web server to secure. You can see from our example code we have allowed un-secured access to our CSS directory and requested that all other resources are secured and can only be accessed by an authenticated user.</li><li><em><em>formLogin()</em></em> — Tells spring security that we wish to use a login form. We provide the login URL, the URL we want to redirect to if the authentication is successful and finally permit access to the login and logout endpoints.</li><li><em><em>csrf()</em></em> — For now we are disabling cross-site request forgery protection which by default is enabled. We will cover this later in the series.</li></ul><p><strong><strong>configureGlobal method</strong></strong><br>Allows us to autowire an <em><em>AuthenticationManager</em></em> which will be used globally throughout our application. For this example, we are using a basic in-memory approach with one user and one user role.</p><h3 id="thymeleaf-namespace">Thymeleaf namespace</h3><p>A few things to note in our <em><em>login.html</em></em><br>The thymeleaf spring security namespace:</p><pre><code class="language-html">&lt;html xmlns="http://www.w3.org/1999/xhtml"  
xmlns:th="http://www.thymeleaf.org"    
xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"&gt;</code></pre><p>The thymeleaf action which instructs the form to do a POST request to the URL provided (/login):</p><pre><code class="language-html">&lt;form th:action="@{/login}" method="post" class="form login"&gt;</code></pre><p>The thymeleaf if condition can check for URL parameters, error and log out responses and display content if they return true:</p><pre><code class="language-html">&lt;div class="text--center" th:if="${param.error}"&gt;
    Invalid username and password.
&lt;/div&gt;
&lt;div class="text--center" th:if="${param.logout}"&gt;
     You have been logged out.
&lt;/div&gt;</code></pre><p>Full list of what's available on the thymeleaf <a href="http://www.thymeleaf.org/doc/tutorials/2.1/thymeleafspring.html#handling-the-command-object" rel="noopener nofollow">website</a></p><h3 id="demo">Demo</h3><p>To run the demo open the <em><em>Application.java</em></em> class and right click run. In order to start the example, port 8080 will need to be available on your machine. If it is not you can change this default in the application.properties file using:</p><!--kg-card-begin: markdown--><pre><code class="language-html">server.port=8081
</code></pre>
<!--kg-card-end: markdown--><p>Set this to whatever value you wish.</p><figure class="kg-card kg-embed-card"><iframe width="612" height="344" src="https://www.youtube.com/embed/aQ6QTQdCfeQ?feature=oembed" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></figure><hr><h3 id="unit-testing">Unit Testing</h3><pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureMockMvc
public class ApplicationTests {

    @Autowired
    private MockMvc mockMvc;

    @Test
    public void loginWithValidUserThenAuthenticated() throws Exception {
        FormLoginRequestBuilder login = formLogin()
                .user("user")
                .password("pass");

        mockMvc.perform(login)
                .andExpect(authenticated().withUsername("user"));
    }

    @Test
    public void loginWithInvalidUserThenUnauthenticated() throws Exception {
        FormLoginRequestBuilder login = formLogin()
                .user("invalid")
                .password("invalidpassword");

        mockMvc.perform(login)
                .andExpect(unauthenticated());
    }

    @Test
    public void accessUnsecuredResourceThenOk() throws Exception {
        mockMvc.perform(get("/css/style.css"))
                .andExpect(status().isOk());
    }

    @Test
    public void accessSecuredResourceUnauthenticatedThenRedirectsToLogin() throws Exception {
        mockMvc.perform(get("/hello"))
                .andExpect(status().is3xxRedirection())
                .andExpect(redirectedUrlPattern("**/login"));
    }

    @Test
    @WithMockUser
    public void accessSecuredResourceAuthenticatedThenOk() throws Exception {
        mockMvc.perform(get("/index"))
                .andExpect(status().isOk());
    }
}</code></pre><p><strong><strong>@RunWith(SpringRunner.class)</strong></strong><br>Tells JUnit to run unit tests with Spring’s testing support</p><p><strong><strong>@SpringBootTest</strong></strong><br>Run as spring boot app. i.e. load application.properties and spring beans</p><p><strong><strong>@AutoConfigureMockMvc</strong></strong><br>Creates a Test helper class called MockMvc. From this, we can imitate a front-end client making requests to the server.</p><p><strong><strong>@WithMockUser</strong></strong><br>Provides the ability to mock certain users. An authenticated user in our case.</p><p><strong><strong>FormLoginRequestBuilder</strong></strong><br>A utility class that allows us to create a form based login request.</p><h1 id="next"><a href="https://codenerve.com/spring-security-thymeleaf-extras/">Next</a></h1><p>Next up, we will be covering spring security’s user roles and the ability to hide and show content on our site based on the user’s permissions.</p><p></p>]]></content:encoded></item></channel></rss>
